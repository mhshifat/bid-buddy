// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Multi-tenant Support
// ============================================================================

model Tenant {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users            User[]
  upwork_profiles  UpworkProfile[]
  jobs             Job[]
  proposals        Proposal[]
  projects         Project[]
  clients          Client[]
  github_profiles  GithubProfile[]
  skills           Skill[]
  connects_ledger  ConnectsLedger[]
  ai_analyses      AiAnalysis[]
  ai_insights      AiInsight[]
  templates        ProposalTemplate[]
  project_scopes   ProjectScope[]
  scope_change_requests ScopeChangeRequest[]
  job_activities   JobActivity[]
  alert_preferences AlertPreference[]
  notification_logs NotificationLog[]

  @@map("tenants")
}

// ============================================================================
// Authentication & Authorization
// ============================================================================

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model User {
  id              String   @id @default(cuid())
  tenant_id       String
  email           String
  name            String
  avatar_url      String?
  role            UserRole @default(MEMBER)
  is_active       Boolean  @default(true)
  email_verified  Boolean  @default(false)
  hashed_password String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  tenant           Tenant            @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  sessions         Session[]
  oauth_accounts   OAuthAccount[]
  proposals        Proposal[]
  projects         ProjectMember[]
  activity         ActivityLog[]
  alert_preference AlertPreference?

  @@unique([tenant_id, email])
  @@index([tenant_id])
  @@map("users")
}

model OAuthAccount {
  id                  String   @id @default(cuid())
  user_id             String
  provider            String
  provider_account_id String
  access_token        String?
  refresh_token       String?
  token_type          String?
  scope               String?
  expires_at          Int?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
  @@index([user_id])
  @@map("oauth_accounts")
}

model Session {
  id         String   @id @default(cuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
  @@map("sessions")
}

// ============================================================================
// Upwork Profile
// ============================================================================

model UpworkProfile {
  id                   String   @id @default(cuid())
  tenant_id            String
  profile_url          String
  display_name         String
  title                String?
  overview             String?
  hourly_rate          Decimal? @db.Decimal(10, 2)
  total_earnings       Decimal? @db.Decimal(12, 2)
  job_success_score    Int?
  total_hours          Decimal? @db.Decimal(10, 2)
  total_jobs           Int?
  available_connects   Int      @default(0)
  profile_visibility   String?
  response_time        String?
  location             String?
  timezone             String?
  raw_data             Json?
  last_synced_at       DateTime?
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, profile_url])
  @@index([tenant_id])
  @@map("upwork_profiles")
}

// ============================================================================
// Job Management
// ============================================================================

enum JobStatus {
  NEW
  ANALYZED
  SHORTLISTED
  BIDDING
  BID_SENT
  INTERVIEWING
  ACCEPTED
  REJECTED
  EXPIRED
  SKIPPED
  FLAGGED
}

enum JobType {
  HOURLY
  FIXED_PRICE
}

enum ExperienceLevel {
  ENTRY
  INTERMEDIATE
  EXPERT
}

model Job {
  id                    String          @id @default(cuid())
  tenant_id             String
  upwork_job_id         String
  title                 String
  description           String
  job_type              JobType
  experience_level      ExperienceLevel?
  budget_min            Decimal?        @db.Decimal(12, 2)
  budget_max            Decimal?        @db.Decimal(12, 2)
  hourly_rate_min       Decimal?        @db.Decimal(10, 2)
  hourly_rate_max       Decimal?        @db.Decimal(10, 2)
  estimated_duration    String?
  job_url               String
  client_country        String?
  client_rating         Decimal?        @db.Decimal(3, 2)
  client_total_spent    Decimal?        @db.Decimal(14, 2)
  client_total_hires    Int?
  client_total_posted   Int?
  client_hire_rate      Decimal?        @db.Decimal(5, 2)
  client_member_since   DateTime?
  client_payment_verified Boolean       @default(false)
  proposals_count       Int?
  connects_required     Int?
  is_featured           Boolean         @default(false)
  is_duplicate          Boolean         @default(false)
  duplicate_of_id       String?
  is_flagged_fake       Boolean         @default(false)
  status                JobStatus       @default(NEW)
  posted_at             DateTime?
  captured_at           DateTime        @default(now())
  skills_required       String[]
  category              String?
  subcategory           String?
  raw_data              Json?
  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt

  tenant        Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  duplicate_of  Job?         @relation("JobDuplicates", fields: [duplicate_of_id], references: [id])
  duplicates    Job[]        @relation("JobDuplicates")
  analyses      AiAnalysis[]
  proposals     Proposal[]
  tags          JobTag[]
  notes         JobNote[]
  ai_insights   AiInsight[]
  scopes        ProjectScope[]
  projects      Project[]    @relation("ProjectOriginJob")
  activities    JobActivity[]

  @@unique([tenant_id, upwork_job_id])
  @@index([tenant_id, status])
  @@index([tenant_id, posted_at])
  @@index([tenant_id, is_duplicate])
  @@index([tenant_id, is_flagged_fake])
  @@map("jobs")
}

model JobTag {
  id         String   @id @default(cuid())
  job_id     String
  tag        String
  created_at DateTime @default(now())

  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@unique([job_id, tag])
  @@index([tag])
  @@map("job_tags")
}

model JobNote {
  id         String   @id @default(cuid())
  job_id     String
  content    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([job_id])
  @@map("job_notes")
}

// ============================================================================
// AI Analysis
// ============================================================================

enum AnalysisType {
  JOB_FIT
  FAKE_DETECTION
  DUPLICATE_CHECK
  PROPOSAL_REVIEW
  CLIENT_ANALYSIS
}

model AiAnalysis {
  id                  String       @id @default(cuid())
  tenant_id           String
  job_id              String
  analysis_type       AnalysisType
  fit_score           Int?         // 0-100
  fake_probability    Int?         // 0-100
  win_probability     Int?         // 0-100
  recommendation      String?      // BID, SKIP, CAUTIOUS
  reasoning           String?
  strengths           String[]
  weaknesses          String[]
  suggested_rate      Decimal?     @db.Decimal(10, 2)
  suggested_duration  String?
  key_points          String[]
  red_flags           String[]
  matched_skills      String[]
  missing_skills      String[]
  model_used          String?
  tokens_used         Int?
  raw_response        Json?
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([tenant_id, job_id])
  @@index([job_id, analysis_type])
  @@map("ai_analyses")
}

// ============================================================================
// Proposals
// ============================================================================

enum ProposalStatus {
  DRAFT
  REVIEW
  READY
  SENT
  VIEWED
  SHORTLISTED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model Proposal {
  id                String         @id @default(cuid())
  tenant_id         String
  job_id            String
  user_id           String
  cover_letter      String
  proposed_rate     Decimal?       @db.Decimal(10, 2)
  proposed_duration String?
  milestones        Json?
  questions_answers Json?
  attachments       Json?
  connects_used     Int?
  status            ProposalStatus @default(DRAFT)
  ai_generated      Boolean        @default(false)
  ai_version        Int?
  sent_at           DateTime?
  viewed_at         DateTime?
  responded_at      DateTime?
  raw_data          Json?
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt

  tenant      Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  job         Job         @relation(fields: [job_id], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  ai_insights AiInsight[]
  projects    Project[]   @relation("ProjectWinningProposal")

  @@index([tenant_id, status])
  @@index([job_id])
  @@map("proposals")
}

model ProposalTemplate {
  id          String   @id @default(cuid())
  tenant_id   String
  name        String
  description String?
  content     String
  variables   String[]
  is_default  Boolean  @default(false)
  category    String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@map("proposal_templates")
}

// ============================================================================
// Project Management
// ============================================================================

enum ProjectStatus {
  PENDING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
  DISPUTED
}

model Project {
  id                  String        @id @default(cuid())
  tenant_id           String
  client_id           String
  job_id              String?
  proposal_id         String?
  title               String
  description         String?
  upwork_contract_id  String?
  job_type            JobType
  budget              Decimal?      @db.Decimal(12, 2)
  hourly_rate         Decimal?      @db.Decimal(10, 2)
  estimated_hours     Decimal?      @db.Decimal(10, 2)
  actual_hours        Decimal?      @db.Decimal(10, 2)
  total_earned        Decimal?      @db.Decimal(12, 2)
  status              ProjectStatus @default(PENDING)
  start_date          DateTime?
  end_date            DateTime?
  deadline            DateTime?
  upwork_feedback     Json?
  client_satisfaction Int?
  notes               String?
  raw_data            Json?
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  tenant          Tenant          @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  client          Client          @relation(fields: [client_id], references: [id], onDelete: Cascade)
  originating_job Job?            @relation("ProjectOriginJob", fields: [job_id], references: [id], onDelete: SetNull)
  winning_proposal Proposal?      @relation("ProjectWinningProposal", fields: [proposal_id], references: [id], onDelete: SetNull)
  members         ProjectMember[]
  milestones      Milestone[]
  tasks           Task[]
  time_logs       TimeLog[]
  scopes          ProjectScope[]

  @@index([tenant_id, status])
  @@index([client_id])
  @@index([job_id])
  @@index([proposal_id])
  @@map("projects")
}

model ProjectMember {
  id         String   @id @default(cuid())
  project_id String
  user_id    String
  role       String   @default("contributor")
  joined_at  DateTime @default(now())

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
  @@map("project_members")
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  PAID
  REVISION
}

model Milestone {
  id          String          @id @default(cuid())
  project_id  String
  title       String
  description String?
  amount      Decimal?        @db.Decimal(12, 2)
  due_date    DateTime?
  status      MilestoneStatus @default(PENDING)
  order       Int             @default(0)
  created_at  DateTime        @default(now())
  updated_at  DateTime        @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@map("milestones")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String       @id @default(cuid())
  project_id  String
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  due_date    DateTime?
  order       Int          @default(0)
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id, status])
  @@map("tasks")
}

model TimeLog {
  id          String   @id @default(cuid())
  project_id  String
  description String?
  hours       Decimal  @db.Decimal(6, 2)
  logged_date DateTime
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@map("time_logs")
}

// ============================================================================
// Client Management
// ============================================================================

enum ClientStatus {
  PROSPECT
  ACTIVE
  INACTIVE
  BLOCKED
}

model Client {
  id                    String       @id @default(cuid())
  tenant_id             String
  upwork_client_id      String?
  name                  String
  company               String?
  email                 String?
  country               String?
  timezone              String?
  upwork_rating         Decimal?     @db.Decimal(3, 2)
  total_spent           Decimal?     @db.Decimal(14, 2)
  total_hires           Int?
  payment_verified      Boolean      @default(false)
  status                ClientStatus @default(PROSPECT)
  notes                 String?
  communication_style   String?
  preferred_contact     String?
  raw_data              Json?
  created_at            DateTime     @default(now())
  updated_at            DateTime     @updatedAt

  tenant   Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  projects Project[]

  @@unique([tenant_id, upwork_client_id])
  @@index([tenant_id, status])
  @@map("clients")
}

// ============================================================================
// Skills & GitHub Integration
// ============================================================================

model GithubProfile {
  id              String   @id @default(cuid())
  tenant_id       String
  github_username String
  access_token    String?
  avatar_url      String?
  bio             String?
  public_repos    Int?
  total_stars     Int?
  top_languages   Json?
  top_repos       Json?
  contributions   Json?
  last_synced_at  DateTime?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, github_username])
  @@index([tenant_id])
  @@map("github_profiles")
}

enum SkillSource {
  MANUAL
  GITHUB
  UPWORK
  AI_DETECTED
}

model Skill {
  id               String      @id @default(cuid())
  tenant_id        String
  name             String
  category         String?
  proficiency      Int?        // 1-10
  years_experience Decimal?    @db.Decimal(4, 1)
  source           SkillSource @default(MANUAL)
  is_primary       Boolean     @default(false)
  created_at       DateTime    @default(now())
  updated_at       DateTime    @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, name])
  @@index([tenant_id])
  @@map("skills")
}

// ============================================================================
// Connects Tracking
// ============================================================================

enum ConnectsTransactionType {
  PURCHASE
  BID_SPENT
  BID_REFUND
  MONTHLY_FREE
  BONUS
  ADJUSTMENT
}

model ConnectsLedger {
  id               String                  @id @default(cuid())
  tenant_id        String
  transaction_type ConnectsTransactionType
  amount           Int
  balance_after    Int
  description      String?
  reference_id     String?
  created_at       DateTime                @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id, created_at])
  @@map("connects_ledger")
}

// ============================================================================
// AI Insights (Persisted AI-generated data for all feature types)
// ============================================================================

enum InsightType {
  BID_STRATEGY
  INTERVIEW_PREP
  SKILL_GAP
  SCOPE_ESTIMATE
  DISCOVERY_QUESTIONS
  CONTRACT_ADVISOR
  PROPOSAL_VARIATIONS
  CLIENT_INTELLIGENCE
  FOLLOW_UP_MESSAGE
  SMART_ALERTS
  STYLE_TRAINER
  WEEKLY_DIGEST
  WIN_PATTERNS
  PROFILE_OPTIMIZER
  SCOPE_CREEP_DETECTION
  SCOPE_CREEP_RESPONSE
  CHANGE_ORDER
}

model AiInsight {
  id           String      @id @default(cuid())
  tenant_id    String
  job_id       String?
  proposal_id  String?
  insight_type InsightType
  result       Json
  model_used   String?
  tokens_used  Int?
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt

  tenant   Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  job      Job?      @relation(fields: [job_id], references: [id], onDelete: Cascade)
  proposal Proposal? @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@index([tenant_id, insight_type])
  @@index([job_id, insight_type])
  @@index([proposal_id, insight_type])
  @@map("ai_insights")
}

// ============================================================================
// Scope Shield – Scope Creep Protection
// ============================================================================

enum ScopeChangeStatus {
  DETECTED
  ACCEPTED
  DECLINED
  NEGOTIATED
}

model ProjectScope {
  id                  String   @id @default(cuid())
  tenant_id           String
  project_id          String?
  job_id              String?
  title               String
  original_description String
  deliverables        String[]
  exclusions          String[]
  milestones          String[]
  agreed_budget       Decimal? @db.Decimal(12, 2)
  agreed_timeline     String?
  revision_limit      Int?
  notes               String?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  tenant          Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  project         Project?            @relation(fields: [project_id], references: [id], onDelete: Cascade)
  job             Job?                @relation(fields: [job_id], references: [id], onDelete: Cascade)
  change_requests ScopeChangeRequest[]

  @@index([tenant_id])
  @@index([project_id])
  @@index([job_id])
  @@map("project_scopes")
}

model ScopeChangeRequest {
  id                String            @id @default(cuid())
  scope_id          String
  tenant_id         String
  client_message    String
  is_out_of_scope   Boolean           @default(false)
  ai_analysis       Json?
  ai_response       Json?
  change_order      Json?
  status            ScopeChangeStatus @default(DETECTED)
  estimated_cost    Decimal?          @db.Decimal(12, 2)
  estimated_hours   Decimal?          @db.Decimal(8, 2)
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  scope  ProjectScope @relation(fields: [scope_id], references: [id], onDelete: Cascade)
  tenant Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([scope_id])
  @@index([tenant_id])
  @@map("scope_change_requests")
}

// ============================================================================
// Activity Log
// ============================================================================

model ActivityLog {
  id             String   @id @default(cuid())
  user_id        String?
  entity_type    String
  entity_id      String
  action         String
  details        Json?
  correlation_id String?
  ip_address     String?
  created_at     DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([entity_type, entity_id])
  @@index([user_id])
  @@index([correlation_id])
  @@map("activity_logs")
}

// ============================================================================
// Job Journey Tracking
// ============================================================================

enum JourneyPhase {
  DISCOVERED
  ANALYZED
  SHORTLISTED
  PROPOSAL_DRAFTED
  PROPOSAL_SENT
  INTERVIEWING
  OFFER_RECEIVED
  WON
  PROJECT_STARTED
  MILESTONE_COMPLETED
  PROJECT_DELIVERED
  PAYMENT_RECEIVED
  FEEDBACK_RECEIVED
  LOST
  SKIPPED
  EXPIRED
}

model JobActivity {
  id           String       @id @default(cuid())
  tenant_id    String
  job_id       String
  proposal_id  String?
  project_id   String?
  phase        JourneyPhase
  title        String
  description  String?
  metadata     Json?
  created_at   DateTime     @default(now())

  tenant  Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  job     Job      @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([job_id])
  @@index([tenant_id, phase])
  @@index([created_at])
  @@map("job_activities")
}

// ============================================================================
// Job Alert & Notification Settings
// ============================================================================

enum NotificationChannel {
  DESKTOP
  SMS
  WHATSAPP
  IN_APP
}

model AlertPreference {
  id                   String                @id @default(cuid())
  tenant_id            String
  user_id              String                @unique
  is_enabled           Boolean               @default(true)

  // Auto-scan settings
  auto_scan_enabled    Boolean               @default(false)
  scan_interval_minutes Int                  @default(10)

  // Match threshold (e.g. 80 means "notify for ≥80% match")
  min_match_percentage Int                   @default(80)

  // Categories to watch (Upwork job categories)
  categories           String[]

  // Skills to match against
  target_skills        String[]

  // Notification channels enabled
  channels             NotificationChannel[]

  // Desktop push notification config
  desktop_enabled      Boolean               @default(false)
  push_subscription    Json?                 // Web Push subscription object

  // SMS notification config
  sms_enabled          Boolean               @default(false)
  sms_phone_number     String?
  sms_country_code     String?
  sms_verified         Boolean               @default(false)

  // WhatsApp notification config (Meta Cloud API — per-user credentials)
  whatsapp_enabled         Boolean               @default(false)
  whatsapp_phone_number    String?               // Recipient's WhatsApp number
  whatsapp_country_code    String?
  whatsapp_verified        Boolean               @default(false)
  whatsapp_access_token    String?               // Meta Cloud API access token
  whatsapp_phone_number_id String?               // Meta Cloud API phone number ID

  created_at           DateTime              @default(now())
  updated_at           DateTime              @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@map("alert_preferences")
}

model NotificationLog {
  id                String              @id @default(cuid())
  tenant_id         String
  job_id            String?
  channel           NotificationChannel
  title             String
  body              String
  match_percentage  Int?
  status            String              @default("pending") // pending, sent, failed
  error_message     String?
  correlation_id    String?
  sent_at           DateTime?
  created_at        DateTime            @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([job_id])
  @@index([created_at])
  @@map("notification_logs")
}
